name: Playground Branch

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  restructure:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restructure repository
        run: |
          mkdir -p packages/plume

          # Move everything into packages/plume, except .git and playground
          for item in $(ls -A); do
            case "$item" in
              .git|playground|packages) ;;
              *) mv "$item" packages/plume/ ;;
            esac
          done

          # Move playground contents to root (including dotfiles)
          mv playground/* playground/.[!.]* . 2>/dev/null || true
          rm -rf playground

      - name: Update composer.json repository path
        run: |
          jq '.repositories["meetplume/plume"].url = "./packages/plume" |
              del(.repositories["meetplume/plume"].options)' \
            composer.json > composer.json.tmp && mv composer.json.tmp composer.json

      - name: Extend .gitignore for package subfolder
        run: |
          echo "" >> .gitignore
          echo "# Package development" >> .gitignore
          echo "/packages/plume/vendor" >> .gitignore
          echo "/packages/plume/node_modules" >> .gitignore
          echo "/packages/plume/.phpunit.cache" >> .gitignore

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, mbstring, zip

      - name: Update composer.lock for new package path and publish assets
        run: |
          composer update meetplume/plume --no-interaction --no-scripts
          php artisan vendor:publish --tag plume-assets
          sed -i '/^public\/vendor\/plume$/d' .gitignore

      - name: Commit and push to playground branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --unset-all http.https://github.com/.extraheader || true
          git remote add playground-remote https://x-access-token:${{ secrets.PLAYGROUND_PAT }}@github.com/meetplume/plume-playground.git
          git add -A
          git commit -m "${{ github.event.head_commit.message || 'Playground commit' }}"
          git push --force playground-remote HEAD:main-playground
